<!doctype html><html lang="ja"><head>
  <meta charset="utf-8" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>フィードバック</title>
</head><body class="bg-light">
<div class="container py-4">
  <a href="/history" class="text-decoration-none">← 履歴</a>
  <h3 class="mt-2">フィードバック</h3>
  <div class="text-muted">{{ session.scenario_title }} / {{ session.id }}</div>

  <div class="card mt-3">
    <div class="card-body">
      <h5 class="card-title">まとめ（仮）</h5>
      {% if feedback %}
        {% if feedback.summary or feedback.good_points or feedback.improvements or feedback.better_questions or feedback.key_moments or feedback.model_answer or feedback.alt_phrasings or feedback.next_actions or feedback.next_drill or feedback.score is not none %}
          {% if feedback.summary %}
            <div class="mb-3">
              <div class="fw-semibold">要約</div>
              <div>{{ feedback.summary }}</div>
            </div>
          {% endif %}

          {% if feedback.score is not none %}
            <div class="mb-3">
              <div class="fw-semibold">スコア</div>
              <div><span class="badge text-bg-primary">{{ feedback.score }}</span></div>
            </div>
          {% endif %}

          {% if feedback.good_points %}
            <div class="mb-3">
              <div class="fw-semibold">良かった点</div>
              <ul class="mb-0">
                {% for x in feedback.good_points %}
                  <li>{{ x }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          {% if feedback.improvements %}
            <div class="mb-3">
              <div class="fw-semibold">改善点</div>
              <ul class="mb-0">
                {% for x in feedback.improvements %}
                  <li>{{ x }}</li>
                {% endfor %}
              </ul>
            </div>

          {% if feedback.better_questions %}
            <div class="mb-3">
              <div class="fw-semibold">次に確認すべき質問</div>
              <ul class="mb-0">
                {% for x in feedback.better_questions %}
                  <li>{{ x }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          {% if feedback.key_moments %}
            <div class="mb-3">
              <div class="fw-semibold">重要局面レビュー</div>
              <ul class="mb-0">
                {% for x in feedback.key_moments %}
                  <li><div style="white-space: pre-wrap;">{{ x }}</div></li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          {% if feedback.model_answer %}
            <div class="mb-3">
              <div class="fw-semibold">模範会話例</div>
              <div style="white-space: pre-wrap;">{{ feedback.model_answer }}</div>
            </div>
          {% endif %}

          {% if feedback.alt_phrasings %}
            <div class="mb-3">
              <div class="fw-semibold">言い換え例</div>
              <ul class="mb-0">
                {% for x in feedback.alt_phrasings %}
                  <li>{{ x }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          {% if feedback.next_drill %}
            <div class="mb-3">
              <div class="fw-semibold">次の1本ノック</div>
              <div>{{ feedback.next_drill }}</div>
            </div>
          {% endif %}
          {% endif %}

          {% if feedback.next_actions %}
            <div class="mb-0">
              <div class="fw-semibold">次のアクション</div>
              <ul class="mb-0">
                {% for x in feedback.next_actions %}
                  <li>{{ x }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        {% else %}
          <pre class="mb-0">{{ feedback | pprint }}</pre>
        {% endif %}
      {% else %}
        <div class="text-muted">まだフィードバックは生成されていません（次ステップでOpenAI評価に置き換えます）。</div>
      {% endif %}
    </div>
  </div>

  <div class="card mt-3">
    <div class="card-body">
      <h5 class="card-title">会話ログ</h5>
      {% if transcript and transcript.transcript %}
        <div class="small">
          {# 連続する同一roleを結合して、Practiceの吹き出し単位（ターン単位）に寄せる #}
          {% set ns = namespace(role=None, text='', out=[]) %}
          {% for m in transcript.transcript %}
            {% if ns.role is none %}
              {% set ns.role = m.role %}
              {% set ns.text = m.text %}
            {% elif m.role == ns.role %}
              {% set ns.text = ns.text + m.text %}
            {% else %}
              {% set _ = ns.out.append({'role': ns.role, 'text': ns.text}) %}
              {% set ns.role = m.role %}
              {% set ns.text = m.text %}
            {% endif %}
          {% endfor %}
          {% if ns.role is not none %}
            {% set _ = ns.out.append({'role': ns.role, 'text': ns.text}) %}
          {% endif %}

          {% for m in ns.out %}
            <div class="mb-2">
              <span class="badge text-bg-{% if m.role == 'user' %}success{% else %}danger{% endif %}">{{ m.role }}</span>
              <span class="ms-2">{{ m.text }}</span>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">ログ未保存です（Practice画面で「終了→保存」すると表示されます）。</div>
      {% endif %}
    </div>
  </div>

  <div class="d-flex gap-2 mt-3">
    {% if transcript and transcript.transcript %}
      <button class="btn btn-success" id="btn-generate-feedback" type="button">フィードバック生成</button>
    {% else %}
      <button class="btn btn-success" id="btn-generate-feedback" type="button" disabled>フィードバック生成</button>
    {% endif %}
    <a class="btn btn-primary" href="/practice/{{ session.id }}">同じシナリオで再挑戦</a>
    <a class="btn btn-outline-secondary" href="/modes">別の練習へ</a>
  </div>

  <div class="text-muted small mt-2" id="generate-feedback-status"></div>
</div>

<script>
(function(){
  const btn = document.getElementById('btn-generate-feedback');
  const statusEl = document.getElementById('generate-feedback-status');
  if (!btn) return;

  btn.addEventListener('click', async function(){
    if (btn.disabled) return;

    btn.disabled = true;
    statusEl.textContent = 'フィードバック生成中...';

    try {
      const res = await fetch('/api/session/{{ session.id }}/feedback/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data || data.ok !== true) {
        const msg = (data && (data.error || (data.feedback && data.feedback.error))) ? (data.error || data.feedback.error) : ('生成に失敗しました（HTTP ' + res.status + '）');
        statusEl.textContent = msg;
        btn.disabled = false;
        return;
      }

      statusEl.textContent = '生成完了。画面を更新します...';
      location.reload();
    } catch (e) {
      statusEl.textContent = '通信エラー: ' + (e && e.message ? e.message : e);
      btn.disabled = false;
    }
  });
})();
</script>

</body></html>