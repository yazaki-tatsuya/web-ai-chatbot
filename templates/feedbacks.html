<!doctype html><html lang="ja"><head>
  <meta charset="utf-8" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>生成済フィードバック一覧</title>
</head><body class="bg-light">
<div class="container py-4">
  <a href="/history" class="text-decoration-none">← 履歴</a>
  <h3 class="mt-2">生成済フィードバック一覧</h3>

  <div class="list-group mt-3">
    {% for f in feedbacks %}
      <div class="list-group-item">
        <div class="d-flex justify-content-between">
          <div>
            <div class="fw-semibold">{{ f.scenario_title }}</div>
            <div class="text-muted small">{{ f.created_at }} / {{ f.mode }} / {{ f.id }}</div>
          </div>
          <div class="d-flex gap-2">
            <a class="btn btn-sm btn-primary" href="/feedback/{{ f.id }}">表示</a>
            <button class="btn btn-sm btn-outline-success btn-regen" type="button" data-sid="{{ f.id }}">再生成</button>
            <button class="btn btn-sm btn-outline-danger btn-del" type="button" data-sid="{{ f.id }}">削除</button>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="text-muted small mt-2" id="feedbacks-status"></div>
</div>

<script>
(function(){
  const statusEl = document.getElementById('feedbacks-status');

  async function postJson(url) {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json().catch(() => ({}));
    return { res, data };
  }

  document.querySelectorAll('.btn-regen').forEach(btn => {
    btn.addEventListener('click', async function(){
      const sid = btn.getAttribute('data-sid');
      if (!sid) return;

      btn.disabled = true;
      if (statusEl) statusEl.textContent = '再生成中...';

      try {
        const { res, data } = await postJson('/api/session/' + sid + '/feedback/generate');
        if (!res.ok || !data || data.ok !== true) {
          const msg = (data && (data.error || (data.feedback && data.feedback.error))) ? (data.error || data.feedback.error) : ('再生成に失敗しました（HTTP ' + res.status + '）');
          if (statusEl) statusEl.textContent = msg;
          btn.disabled = false;
          return;
        }
        if (statusEl) statusEl.textContent = '再生成完了。画面を更新します...';
        location.reload();
      } catch (e) {
        if (statusEl) statusEl.textContent = '通信エラー: ' + (e && e.message ? e.message : e);
        btn.disabled = false;
      }
    });
  });

  document.querySelectorAll('.btn-del').forEach(btn => {
    btn.addEventListener('click', async function(){
      const sid = btn.getAttribute('data-sid');
      if (!sid) return;

      btn.disabled = true;
      if (statusEl) statusEl.textContent = '削除中...';

      try {
        const { res, data } = await postJson('/api/session/' + sid + '/feedback/delete');
        if (!res.ok || !data || data.ok !== true) {
          const msg = (data && data.error) ? data.error : ('削除に失敗しました（HTTP ' + res.status + '）');
          if (statusEl) statusEl.textContent = msg;
          btn.disabled = false;
          return;
        }
        if (statusEl) statusEl.textContent = '削除完了。画面を更新します...';
        location.reload();
      } catch (e) {
        if (statusEl) statusEl.textContent = '通信エラー: ' + (e && e.message ? e.message : e);
        btn.disabled = false;
      }
    });
  });
})();
</script>

</body></html>
