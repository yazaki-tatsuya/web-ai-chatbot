<!-- 
    とりあえず、口パクの画像切り換えに挑戦するも、それすらも上手くいかない。
-->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>AIチャットインターフェース</title>
    <!-- integrity 属性を削除 -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js" crossorigin="anonymous"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #f0f2f5; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            height: 100vh; 
            margin: 0;
        }
        #chat { 
            width: 80%; 
            max-width: 800px; 
            margin: 20px auto; 
            border: 1px solid #ccc; 
            padding: 10px; 
            height: 400px; 
            overflow-y: scroll; 
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 5px;
        }
        .message { 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 5px; 
            max-width: 70%;
            word-wrap: break-word;
        }
        .user { 
            background-color: #d1e7dd; 
            text-align: right; 
            margin-left: auto;
        }
        .ai { 
            background-color: #f8d7da; 
            text-align: left; 
            margin-right: auto;
        }
        #status { 
            width: 80%; 
            max-width: 800px; 
            margin: 10px auto; 
            font-size: 0.9em; 
            color: gray; 
            height: 100px; 
            overflow-y: scroll; 
            border: 1px solid #ccc; 
            padding: 5px; 
            background-color: #f1f1f1;
            box-shadow: 0 0 5px rgba(0,0,0,0.05);
            border-radius: 5px;
        }
        /* AIアバター用のスタイル */
        #ai-avatar-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin-bottom: 10px;
        }
        #ai-avatar {
            width: 100%;
            height: 100%;
        }
    </style>
    <style>
        /* interim仮認識の吹き出しを薄色に */
        .user.user-interim {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- AIアバター表示エリア -->
    <div id="ai-avatar-container">
        <img id="ai-avatar" src="/static/ai_avatar_closed.png" alt="AI Avatar">
    </div>
    <div id="chat"></div>
    <div id="status"></div>

    <script>
        const socket = io();


        // AIアバターの口の動きを、テキストの長さに合わせて保持する関数
        function animateAvatarForText(text) {
            const avatarImg = document.getElementById('ai-avatar');
            // 口を開く
            avatarImg.src = "/static/ai_avatar_open.png";
            // 例として、最低1秒＋1文字あたり200msに設定（必要に応じて調整）
            const duration = 1000 + text.length * 200;
            setTimeout(() => {
                avatarImg.src = "/static/ai_avatar_closed.png";
            }, duration);
        }

        const messages = [];

        function insertMessage(role, text, timestamp) {
            const chat = document.getElementById('chat');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + role;
            msgDiv.textContent = text;

            const msg = { role: role, text: text, timestamp: timestamp || Date.now() };
            messages.push(msg);
            messages.sort((a, b) => a.timestamp - b.timestamp);

            // DOM内のどこに挿入すべきか探す
            const children = Array.from(chat.children);
            let inserted = false;
            for (let i = 0; i < children.length; i++) {
                const existingText = children[i].textContent;
                const matching = messages.find(m => m.text === existingText);
                if (matching && matching.timestamp > msg.timestamp) {
                    chat.insertBefore(msgDiv, children[i]);
                    inserted = true;
                    break;
                }
            }
            if (!inserted) {
                chat.appendChild(msgDiv);
            }
            chat.scrollTop = chat.scrollHeight;
        }

        // turn番号・interim対応
        function addUserMessage(message, turn, interim) {
            const chat = document.getElementById('chat');
            let msgDiv = chat.querySelector('.message.user[data-turn="' + turn + '"]');
            if (!msgDiv) {
                msgDiv = document.createElement('div');
                msgDiv.className = 'message user';
                msgDiv.setAttribute('data-turn', turn);
                chat.appendChild(msgDiv);
            }
            msgDiv.textContent = message;
            if (interim) {
                msgDiv.classList.add('user-interim');
            } else {
                msgDiv.classList.remove('user-interim');
            }
            chat.scrollTop = chat.scrollHeight;
            console.log('ユーザーのメッセージを追加しました:', message, 'turn:', turn, 'interim:', interim);
        }

        // AIの応答を表示する関数
        function addAIMessage(message) {
            const chat = document.getElementById('chat');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ai';
            msgDiv.textContent = message;
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
            console.log('AIのメッセージを追加しました:', message);
            // AIの応答に合わせてアバターの口を動かす
            animateAvatarForText(message);
        }

        // ステータスメッセージを表示する関数
        function addStatusMessage(message) {
            const status = document.getElementById('status');
            const statusMsg = document.createElement('div');
            statusMsg.textContent = message;
            status.appendChild(statusMsg);
            status.scrollTop = status.scrollHeight;
            console.log('ステータスメッセージを追加しました:', message);
        }
// AI音声データ受信＆再生
socket.on('ai_audio', function(data) {
    // base64データをArrayBufferに変換
    const base64 = data.audio;
    const binary = atob(base64);
    const len = binary.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binary.charCodeAt(i);
    }
    // Blobを生成（WAV/PCM想定。必要に応じてMIME typeを変更）
    const blob = new Blob([bytes], { type: 'audio/wav' });
    const url = URL.createObjectURL(blob);
    // Audio要素で再生
    const audio = new Audio(url);
    audio.play();
    // 再生後にURLを解放
    audio.onended = () => {
        URL.revokeObjectURL(url);
    };
});

        socket.on('connect', () => {
            console.log('サーバーに接続しました。');
            // ユーザーの接続をチャットに表示
            addUserMessage('ユーザーが接続しました。');
        });

        socket.on('user_message', (data) => {
            console.log('ユーザーのメッセージ:', data.message, 'turn:', data.turn, 'interim:', data.interim);
            addUserMessage(data.message, data.turn || 0, data.interim || false);
        });

        socket.on('ai_message', (data) => {
            console.log('AIのメッセージ:', data.message);
            // AIメッセージがオブジェクトの場合は、テキストを抽出
            if (typeof data.message === 'object' && data.message !== null) {
                const transcript = data.message.transcript || JSON.stringify(data.message);
                addAIMessage(transcript, data.timestamp);
            } else {
                addAIMessage(data.message, data.timestamp);
            }
        });

        socket.on('status_message', (data) => {
            console.log('ステータスメッセージ:', data.message);
            addStatusMessage(data.message);
        });

        // ユーザーからの音声入力が完了したら、ユーザーのメッセージをチャットに追加するロジックを追加することも可能です。
        // 現在はバックエンドからのメッセージのみを表示しています。
    </script>
</body>
</html>

