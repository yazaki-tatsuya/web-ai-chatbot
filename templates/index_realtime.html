<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Realtime Èü≥Â£∞Âêπ„ÅçÂá∫„Åó v2 (JWT)</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f0f2f5;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
    }
    #chat {
      width: 80%;
      max-width: 800px;
      height: 400px;
      overflow-y: auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 10px;
      margin-top: 20px;
    }
    .user {
      background-color: #d1e7dd;
      padding: 8px 10px;
      border-radius: 6px;
      margin: 6px;
      text-align: right;
    }
    .ai {
      background-color: #f8d7da;
      padding: 8px 10px;
      border-radius: 6px;
      margin: 6px;
      text-align: left;
    }
    #status {
      margin-top: 10px;
      width: 80%;
      max-width: 800px;
      height: 80px;
      background: #f4f4f4;
      overflow-y: auto;
      padding: 5px;
      border-radius: 5px;
      font-size: 0.9em;
      color: gray;
    }
  </style>
</head>
<body>
  <h3>Realtime Audio Chat (JWTÁõ¥Áµê)</h3>
  <div class="mb-3">
    <!-- ‚ñº‚ñº ËøΩÂä†(1/2)Ôºö„Éó„É≠„É≥„Éó„ÉàÂÖ•ÂäõÊ¨Ñ ‚ñº‚ñº -->
    <textarea id="prompt" class="form-control mb-2" rows="3" placeholder="„Åì„Åì„Å´„Ç∑„Éä„É™„Ç™/Ë®≠ÂÆöÔºà„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„ÉàÔºâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰æãÔºö„ÅÇ„Å™„Åü„ÅØÂé≥„Åó„ÇÅ„ÅÆËã±‰ºöË©±„Ç≥„Éº„ÉÅ„Åß„Åô„ÄÇÁü≠Êñá„ÅßËøîÁ≠î„Åó„ÄÅÊØéÂõû1Êñá„Å†„ÅëÊ∑ªÂâä„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"></textarea>
    <!-- ‚ñ≤‚ñ≤ ËøΩÂä†(1/2) „Åì„Åì„Åæ„Åß ‚ñ≤‚ñ≤ -->
    <button id="start-btn" class="btn btn-primary">RealtimeÈñãÂßã</button>
  </div>
  <div id="chat"></div>
  <div id="status"></div>
  <script>
    const chat = document.getElementById('chat');
    const statusArea = document.getElementById('status');
    let pc, dataChannel;
    let lastUserFinalEl = null; // Êó¢Â≠òÂ§âÊï∞„ÅØÊÆãÁΩÆÔºà‰∏ã‰Ωç‰∫íÊèõ„ÅÆ„Åü„ÇÅÔºâ
    let provisionalUserBubble = null;   // speech_started Áõ¥Âæå„Å´Âá∫„ÅôÊö´ÂÆö„Éê„Éñ„É´

    // ‚òÖËøΩÂä†Ôºö‰ªä„ÄåË™∞„ÅÆ„É¶„Éº„Ç∂„Éº„Çø„Éº„É≥„Äç„ÇíËÇâ‰ªò„Åë‰∏≠„Åã
    let activeUserRootId = null;    

    // ‚ñº‚ñº ËøΩË®òÔºöitemÈ†ÜÂ∫èÂà∂Âæ°Áî®„ÅÆ„Éû„ÉÉ„Éó„Å®ÊåøÂÖ•„Éò„É´„Éë ‚ñº‚ñº
    const nodeByItem = new Map();        // item_id -> DOM„Éé„Éº„Éâ
    const waitingChildren = new Map();   // parent_item_id -> [Â≠ê„Éé„Éº„ÉâÂæÖÊ©üÂàó]
    // ËøΩÂä†: „É¶„Éº„Ç∂„ÉºÁô∫Ë©±Áµ±ÂêàÁî®„ÅÆ„É°„ÇøÊÉÖÂ†±
    const itemRole = new Map();          // item_id -> 'user' | 'assistant' ...
    const itemRoot = new Map();          // item_id -> root item_idÔºà„É¶„Éº„Ç∂„ÉºÈÄ£Á∂öÁô∫Ë©±„ÅÆÂÖàÈ†≠Ôºâ
    const rootItems = new Map();         // root item_id -> [item_id, ...]ÔºàÂêå„ÅòÂêπ„ÅçÂá∫„Åó„Å´Áµ±Âêà„Åï„Çå„ÇãÈ†ÜÂ∫èÔºâ
    const userTextByItem = new Map();    // item_id -> transcript

    function insertAfterAnchor(node, previousId) {
      const anchor = nodeByItem.get(previousId);
      if (anchor && anchor.parentNode) {
        anchor.insertAdjacentElement('afterend', node);
        return true;
      }
      return false;
    }

    function registerNode(id, node, previousId) {
      node.classList.add('streaming'); // ÁîüÊàêÊôÇ„ÅØÊö´ÂÆöË°®Á§∫
      if (previousId) {
        if (!insertAfterAnchor(node, previousId)) {
          const q = waitingChildren.get(previousId) || [];
          q.push(node);
          waitingChildren.set(previousId, q);
        }
      } else {
        // ÂÖàÈ†≠Ë¶ÅÁ¥†Ôºàprevious„ÅåÁÑ°„ÅÑÂ†¥ÂêàÔºâ„ÅØÊú´Â∞æ„Å´
        if (!node.parentNode) chat.appendChild(node);
      }
      nodeByItem.set(id, node);

      // Ëá™ÂàÜ„ÇíÂæÖ„Å£„Å¶„ÅÑ„ÅüÂ≠ê„Çí„Åì„ÅÆÁõ¥Âæå„Å´‰∏¶„Åπ„Çã
      const children = waitingChildren.get(id);
      if (children && children.length) {
        let last = node;
        for (const child of children) {
          if (!child.parentNode) last.insertAdjacentElement('afterend', child);
          last = child;
        }
        waitingChildren.delete(id);
      }
    }
    // ‚ñ≤‚ñ≤ ËøΩË®ò„Åì„Åì„Åæ„Åß ‚ñ≤‚ñ≤

    async function appendStatus(msg){ 
      const div = document.createElement('div');
      div.textContent = "> " + msg;
      statusArea.appendChild(div);
      statusArea.scrollTop = statusArea.scrollHeight;
    }

    // üí¨ Âêπ„ÅçÂá∫„ÅóÂΩ¢Âºè„Åß„É¶„Éº„Ç∂„ÉºÁô∫Ë©±ÔºàÁ∑ëËâ≤Ôºâ
    async function appendUser(msg) {
      const bubble = document.createElement('div');
      bubble.className = 'message user';
      bubble.textContent = msg.trim();
      chat.appendChild(bubble);
      chat.scrollTop = chat.scrollHeight;
    }

    // üí¨ Âêπ„ÅçÂá∫„ÅóÂΩ¢Âºè„ÅßAIÁô∫Ë©±ÔºàËµ§Ëâ≤Ôºâ
    async function appendAI(msg, stream = false) {
      let bubble = chat.querySelector('.message.ai.streaming');
      if (!bubble || !stream) {
        // Êó¢Â≠ò„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÅØÊÆãÁΩÆÔºàÈùûJSONÊôÇÁî®Ôºâ
        let uStream = chat.querySelector('.message.user.streaming');
        if (!uStream && !lastUserFinalEl) {
          uStream = document.createElement('div');
          uStream.className = 'message user streaming';
          uStream.textContent = '‚Ä¶';
          chat.appendChild(uStream);
        }
        bubble = document.createElement('div');
        bubble.className = 'message ai streaming';
        const u = chat.querySelector('.message.user.streaming') || lastUserFinalEl;
        if (u && u.parentNode === chat) {
          u.insertAdjacentElement('afterend', bubble);
        } else {
          chat.appendChild(bubble);
        }
      }
      bubble.textContent = msg.trim();
      chat.scrollTop = chat.scrollHeight;
    }

    async function getJWT(){
      try {
        const res = await fetch('/jwt');
        const data = await res.json();
        return data.jwt;
      } catch(e){
        console.error("JWTÂèñÂæóÂ§±Êïó:", e);
        appendStatus("JWTÂèñÂæó„Å´Â§±Êïó");
        return null;
      }
    }

    async function startRealtime(){
      const token = await getJWT();
      if(!token){ appendStatus("„Éà„Éº„ÇØ„É≥„Å™„Åó"); return; }

      const MODEL = "gpt-realtime";
      const offer = await createLocalOffer();
      appendStatus("SDP‰ΩúÊàêÂÆå‰∫Ü");

      // ‚úÖ Flask„Çµ„Éº„Éê„Éº„ÅÆsdp-proxy„ÇíÁµåÁî±„Åó„Å¶CORS„ÇíÂõûÈÅø
      const proxyUrl = "/realtime/sdp-proxy";
      const r = await fetch(proxyUrl, {
        method: "POST",
        headers: { "Content-Type": "application/sdp" },
        body: offer.sdp
      });

      if (!r.ok) {
        appendStatus("SDP proxy fetchÂ§±Êïó: " + r.status);
        return;
      }

      const answerSDP = await r.text();
      await pc.setRemoteDescription({ type: "answer", sdp: answerSDP });
      appendStatus("RealtimeÊé•Á∂öÂÆå‰∫Ü (via Flask proxy)");
    }

    async function createLocalOffer(){
      pc = new RTCPeerConnection();
      dataChannel = pc.createDataChannel("oai-events");

      // --- DataChannel openÁõ¥Âæå„Å´ WebRTC „Çª„ÉÉ„Ç∑„Éß„É≥„Å∏ session.update „ÇíÈÄÅ„Çã --- //
      dataChannel.onopen = () => { // NEW(‚òÖ)
        // ‚ñº‚ñº ËøΩÂä†(2/2)Ôºö„ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÂÄ§„Çí instructions „Å´ÈÅ©Áî® ‚ñº‚ñº
        const promptEl = document.getElementById('prompt');
        const userInstructions = (promptEl && promptEl.value.trim()) ? promptEl.value.trim()
                               : "„ÅÇ„Å™„Åü„ÅØË¶™Âàá„ÅßÊúâËÉΩ„Å™„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇÂøúÁ≠î„ÅØÁ∞°ÊΩî„Å´„ÄÇ";
        // ‚ñ≤‚ñ≤ ËøΩÂä†(2/2) „Åì„Åì„Åæ„Åß ‚ñ≤‚ñ≤

        // WebRTC„Çª„ÉÉ„Ç∑„Éß„É≥„Å´ÂØæ„Åó„Å¶‚Äú„Åì„ÅÆÊé•Á∂ö‚Äù„ÅÆË®≠ÂÆö„ÇíÈÅ©Áî®Ôºà„Çµ„Éº„ÉêÂÅ¥WS„Å´„ÅØÂΩ±Èüø„Åó„Å™„ÅÑÔºâ
        const update = {
          type: "session.update",
          session: {
            input_audio_transcription: {
              model: "whisper-1",
              language: "ja",
            },
            turn_detection: {
              type: "server_vad",
              threshold: 0.5,
              // „ÄåÁÑ°Èü≥„Åå„Åì„ÅÆ„Åè„Çâ„ÅÑÁ∂ö„ÅÑ„Åü„Çâ1Áô∫Ë©±„Å®„Åó„Å¶Âå∫Âàá„Çã„Äç„ÅÆÁßíÊï∞„Ç§„É°„Éº„Ç∏
              // ÂÄ§„ÇíÂ∞è„Åï„Åè„Åô„Çã„Å®„ÄÅÁü≠„ÅÑÈñì„Åß„ÇÇÂ∞èÂàª„Åø„Å´Âå∫Âàá„Å£„Å¶„Åè„Çå„ÇãÔºàÔºù„ÉÜ„Ç≠„Çπ„Éà„ÇÇÊó©„ÅèÂá∫„ÇÑ„Åô„ÅÑÔºâ
              // silence_duration_ms: 300,      // „Åì„Åì„Çí 300ms ÂâçÂæå„Å´
              prefix_padding_ms: 300,        // Áõ¥Ââç„ÅÆÈü≥Â£∞„ÇÇÂ∞ë„Åó„Å†„ÅëÂ∑ª„ÅçÊàª„Åó„Å¶Âê´„ÇÅ„Çã
              idle_timeout_ms: null
            },
            instructions: userInstructions
          }
        };
        dataChannel.send(JSON.stringify(update));
        appendStatus("session.update „ÇíÈÄÅ‰ø°ÔºàWebRTC, with instructionsÔºâ");
      };
      // ----------------------------------------------------------------------- //  

      dataChannel.onmessage = (event) => {
        const msg = event.data;
        console.log("üì© DataChannelÂèó‰ø°:", msg);
        try {
          const parsed = JSON.parse(msg);

          // ‚ñº‚ñº‚ñº „Çπ„É¨„ÉÉ„ÉâÈ†Ü„ÅÆÂü∫Ê∫ñÔºàprevious_item_idÔºâ + Âêπ„ÅçÂá∫„ÅóÁµ±Âêà„É≠„Ç∏„ÉÉ„ÇØ ‚ñº‚ñº‚ñº
          if (parsed.type === "conversation.item.created" && parsed.item) {
            const it = parsed.item;
            const prev = parsed.previous_item_id || null;
            itemRole.set(it.id, it.role);

            // ‚òÖËøΩÂä†‚ë†Ôºö„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„ÅåÂá∫„Å¶„Åç„Åü„Çâ„ÄåÁõ¥Ââç„ÅÆ„É¶„Éº„Ç∂„Éº„Çø„Éº„É≥„ÅØÁµÇ„Çè„Çä„Äç
            if (it.role === 'assistant') {
              // ‰ªä„Åó„ÇÉ„Åπ„Å£„Å¶„ÅÑ„Çã„É¶„Éº„Ç∂„Éº„Çø„Éº„É≥„ÅØÁÑ°„Åó„Å´„Åô„Çã
              activeUserRootId = null;

              // „ÇÇ„Åó‰Ωø„Çè„Çå„Å™„Åã„Å£„ÅüÊö´ÂÆö„Äå‚Ä¶„Äç„Éê„Éñ„É´„ÅåÊÆã„Å£„Å¶„ÅÑ„Åü„ÇâÂâäÈô§
              if (provisionalUserBubble) {
                provisionalUserBubble.remove();
                provisionalUserBubble = null;
              }

              // „Åì„ÅÆÂæå„ÅÆ user Áî®„ÅÆÂá¶ÁêÜ„ÅØ„Çπ„Ç≠„ÉÉ„Éó„Åó„Åü„ÅÑ„ÅÆ„Åß return
              // Ôºà„ÇÇ„Åó„Ç¢„Ç∑„Çπ„Çø„É≥„ÉàÂÅ¥„ÅÆDOMÁîüÊàê„Çí„Åì„Åì„Åß„ÇÑ„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅ
              //  return „ÅÆ‰ª£„Çè„Çä„Å´„ÄåassistantÁî®„ÅÆÊó¢Â≠òÂá¶ÁêÜ„Äç„Çí„Åì„ÅÆ‰∏ã„Å´Êõ∏„ÅèÔºâ
              // „ÅÑ„ÅæË≤º„Å£„Å¶„ÅÑ„Åü„Å†„ÅÑ„Åü„Ç≥„Éº„Éâ„ÅØ user Áî®„Å†„Åë„Å†„Å£„Åü„ÅÆ„Åß„ÄÅ
              // ‰ªäÂõû„ÅØ return „ÅßOK
              return;
            }

            // ‚ñº „Åì„Åì„Åã„Çâ‰∏ã„ÅØÊó¢Â≠ò„ÅÆ„ÄåuserÁî®„Äç„É≠„Ç∏„ÉÉ„ÇØ„Çí„Åù„ÅÆ„Åæ„ÅæÂà©Áî® ‚ñº
            if (it.role === 'user') {
              let rootId;
              let bubble;

              if (prev && itemRole.get(prev) === 'user') {
                // Áõ¥Ââç„ÇÇ user ‚Üí Âêå„Åò root „Å´„Å∂„Çâ‰∏ã„Åí„Çã
                rootId = itemRoot.get(prev) || prev;
                itemRoot.set(it.id, rootId);

                bubble = nodeByItem.get(rootId) || nodeByItem.get(prev);
                if (bubble) {
                  nodeByItem.set(it.id, bubble); // Âêå„ÅòDOM„Éé„Éº„Éâ„ÇíÂÖ±Êúâ
                }

                const arr = rootItems.get(rootId) || [rootId];
                if (!arr.includes(it.id)) arr.push(it.id);
                rootItems.set(rootId, arr);

              } else {
                // Êñ∞„Åó„ÅÑ„É¶„Éº„Ç∂„ÉºÁô∫Ë©± ‚Üí Êñ∞„Åó„ÅÑ root
                rootId = it.id;
                itemRoot.set(it.id, rootId);
                rootItems.set(rootId, [it.id]);

                // speech_started „Åß‰Ωú„Å£„ÅüÊö´ÂÆö„Éê„Éñ„É´„Åå„ÅÇ„Çå„Å∞„Åù„Çå„ÇíÊé°Áî®
                if (provisionalUserBubble) {
                  bubble = provisionalUserBubble;
                  provisionalUserBubble = null;
                  bubble.classList.remove('provisional');
                  // Êó¢„Å´ chat „Å´ append Ê∏à„Åø„Å™„ÅÆ„Åß„ÄÅregisterNode ÂÜÖ„Åß‰∫åÈáç append „Åï„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´
                  registerNode(it.id, bubble, prev);
                } else {
                  // Êö´ÂÆö„ÅåÁÑ°„Åë„Çå„Å∞‰ªä„Åæ„ÅßÈÄö„ÇäÊñ∞Ë¶è‰ΩúÊàê
                  bubble = document.createElement('div');
                  bubble.className = 'message user streaming';
                  bubble.textContent = '‚Ä¶';
                  registerNode(it.id, bubble, prev);
                }
              }

              userTextByItem.set(it.id, "");
              chat.scrollTop = chat.scrollHeight;
            }
          }
          // ‚ñ≤‚ñ≤‚ñ≤ „Åì„Åì„Åæ„Åß ‚ñ≤‚ñ≤‚ñ≤

          // Áô∫Ë©±ÈñãÂßãÊôÇÔºàDOM„ÅØ conversation.item.created ÂÅ¥„Åß‰ΩúÊàê„Åô„ÇãÔºâ
          if (parsed.type === "input_audio_buffer.speech_started") {
            // ‚òÖÊó¢„Å´„ÄåËÇâ‰ªò„Åë‰∏≠„ÅÆ„É¶„Éº„Ç∂„Éº„Çø„Éº„É≥„Äç„Åå„ÅÇ„Çã„ÄÅ„Åæ„Åü„ÅØ
            // ‰Ωø„Çè„Çå„Å¶„Å™„ÅÑÊö´ÂÆö„Éê„Éñ„É´„ÅåÊÆã„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ
            // ‚Üí Êñ∞„Åó„ÅÑ„Äå‚Ä¶„Äç„Éê„Éñ„É´„ÅØ‰Ωú„Çâ„Å™„ÅÑÔºàÔºùÂêå„Åò„Éê„Éñ„É´„Çí‰Ωø„ÅÑÁ∂ö„Åë„ÇãÔºâ
            if (activeUserRootId || provisionalUserBubble) {
              return;
            }

            window._userBuffer = "";

            // Êñ∞„Åó„ÅÑÊö´ÂÆö„Éê„Éñ„É´„ÇíÂç≥ÊôÇË°®Á§∫
            const bubble = document.createElement('div');
            bubble.className = 'message user streaming provisional';
            bubble.textContent = '‚Ä¶';
            chat.appendChild(bubble);
            chat.scrollTop = chat.scrollHeight;
            provisionalUserBubble = bubble;
          }

          // if (parsed.type === "input_audio_buffer.transcription.delta" && parsed.delta) {
          //   window._userBuffer += parsed.delta;
          //   let bubble = chat.querySelector('.message.user.streaming');
          //   if (!bubble) {
          //     bubble = document.createElement('div');
          //     bubble.className = 'message user streaming';
          //     chat.appendChild(bubble);
          //   }
          //   bubble.textContent = window._userBuffer.trim();
          //   chat.scrollTop = chat.scrollHeight;
          // }
          // else if (parsed.type === "input_audio_buffer.transcription.completed" && parsed.transcription) {
          //   window._userBuffer = parsed.transcription;
          //   let bubble = chat.querySelector('.message.user.streaming');
          //   if (!bubble) {
          //     bubble = document.createElement('div');
          //     bubble.className = 'message user streaming';
          //     chat.appendChild(bubble);
          //   }
          //   bubble.textContent = window._userBuffer.trim();
          //   bubble.classList.remove('streaming');
          //   lastUserFinalEl = bubble;
          //   chat.scrollTop = chat.scrollHeight;
          // }
          // ‚ñº‚ñº‚ñº WebRTC‰∫íÊèõ„Ç§„Éô„É≥„ÉàÔºödelta Âçò‰Ωç„Åß„Äåitem„Åî„Å®„Äç„Å´Êõ¥Êñ∞„Åó„ÄÅroot „ÅßÂÜçË®àÁÆó ‚ñº‚ñº‚ñº
          else if (parsed.type === "conversation.item.input_audio_transcription.delta" && parsed.delta) {
            const { item_id, delta } = parsed;

            // Âøµ„ÅÆ„Åü„ÇÅ role „Åå user ‰ª•Â§ñ„Å™„ÇâÁÑ°Ë¶ñ
            if (itemRole.get(item_id) !== 'user') {
              return;
            }

            // „Å©„ÅÆ„É´„Éº„Éà„É°„ÉÉ„Çª„Éº„Ç∏ÔºàÔºù1„Å§„ÅÆÁ∑ë„Éê„Éñ„É´Ôºâ„Å´Â±û„Åô„Çã„Åã
            const rootId = itemRoot.get(item_id) || item_id;
            activeUserRootId = rootId;

            // „É´„Éº„Éà„Å´ÂØæÂøú„Åô„Çã„Éê„Éñ„É´„ÇíÂèñÂæó
            let bubble = nodeByItem.get(rootId);

            // „Åæ„Å†„Éê„Éñ„É´„ÅåÁ¥ê„Å•„ÅÑ„Å¶„ÅÑ„Å™„ÅÑÔºÜÊö´ÂÆö„Éê„Éñ„É´„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ
            // Êö´ÂÆö„Éê„Éñ„É´„Çí„ÄåÊ≠£Âºè„Éê„Éñ„É´„Äç„Å®„Åó„Å¶ÊòáÊ†º„Åï„Åõ„Çã
            if (!bubble && provisionalUserBubble) {
              bubble = provisionalUserBubble;
              provisionalUserBubble = null;

              nodeByItem.set(rootId, bubble);
              nodeByItem.set(item_id, bubble);
            }

            // „Åù„Çå„Åß„ÇÇË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅÆ‰øùÈô∫
            if (!bubble) {
              bubble = document.createElement('div');
              bubble.className = 'message user streaming';
              bubble.textContent = '‚Ä¶';
              registerNode(rootId, bubble, null);
              nodeByItem.set(rootId, bubble);
              nodeByItem.set(item_id, bubble);
            }

            // ‚òÖ 1) item Âçò‰Ωç„Åß„ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞Ôºà„Åì„Åì„Åß„ÅØ item_id „Åî„Å®„Å´ÊåÅ„Å§Ôºâ
            const prevItemText = userTextByItem.get(item_id) || "";
            const newItemText = prevItemText + delta;
            userTextByItem.set(item_id, newItemText);

            // ‚òÖ 2) root ÈÖç‰∏ã„ÅÆ item „ÇíÈ†ÜÁï™„Å´ÈÄ£Áµê„Åó„Å¶„ÄÅ„Éê„Éñ„É´ÂÖ®‰Ωì„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÜçË®àÁÆó
            const chain = rootItems.get(rootId) || [rootId];
            let merged = "";
            for (const id of chain) {
              merged += (userTextByItem.get(id) || "");
            }

            bubble.textContent = merged || '‚Ä¶';
            chat.scrollTop = chat.scrollHeight;
          }
          else if (parsed.type === "conversation.item.input_audio_transcription.completed" && parsed.transcript) {
            const itemId = parsed.item_id;

            // user ‰ª•Â§ñ„ÅÆ completed „ÅØÁÑ°Ë¶ñ
            if (itemRole.get(itemId) !== 'user') {
              return;
            }

            // ‚òÖ „Åì„ÅÆ item „ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Çí„ÄåÊúÄÁµÇ transcript „Åß‰∏äÊõ∏„Åç„Äç
            userTextByItem.set(itemId, parsed.transcript || "");

            const rootId = itemRoot.get(itemId) || itemId;
            const bubble = nodeByItem.get(rootId);
            if (bubble) {
              // root ÈÖç‰∏ã„ÅÆ item „Åü„Å°„ÇíÈ†ÜÁï™„Å´ÈÄ£Áµê„Åó„Å¶Á¢∫ÂÆö„ÉÜ„Ç≠„Çπ„Éà„Å´„Åô„Çã
              const chain = rootItems.get(rootId) || [rootId];
              let merged = "";
              for (const id of chain) {
                merged += (userTextByItem.get(id) || "");
              }
              bubble.textContent = merged.trim();
              bubble.classList.remove('streaming');
              lastUserFinalEl = bubble; // Êó¢Â≠ò‰∫íÊèõ
              chat.scrollTop = chat.scrollHeight;
            }
          }

          // ‚úÖ AIÂøúÁ≠î Âêπ„ÅçÂá∫„ÅóÁî®„Éê„ÉÉ„Éï„Ç°
          if (!window._aiBuffer) window._aiBuffer = "";

          if (parsed.type === "response.audio_transcript.delta" && parsed.delta) {
            window._aiBuffer += parsed.delta;
            let bubble = nodeByItem.get(parsed.item_id);
            if (!bubble) {
              // ‰∫íÊèõÔºöÈÄöÂ∏∏„ÅØÂÖà„Å´ conversation.item.created „ÅåÊù•„Çã„Åå„ÄÅÊú™ÁôªÈå≤ÊôÇ„ÅØÊö´ÂÆö‰ΩúÊàê
              bubble = document.createElement('div');
              bubble.className = 'message ai streaming';
              chat.appendChild(bubble);
              nodeByItem.set(parsed.item_id, bubble);
            }
            bubble.textContent = window._aiBuffer.trim();
            chat.scrollTop = chat.scrollHeight;
          }
          else if (parsed.type === "response.audio_transcript.done" && parsed.transcript) {
            window._aiBuffer = parsed.transcript;
            let bubble = nodeByItem.get(parsed.item_id);
            if (!bubble) {
              bubble = document.createElement('div');
              bubble.className = 'message ai streaming';
              chat.appendChild(bubble);
              nodeByItem.set(parsed.item_id, bubble);
            }
            bubble.textContent = window._aiBuffer.trim();
            bubble.classList.remove('streaming');
            chat.scrollTop = chat.scrollHeight;
          }
          else {
            console.debug("üìò ‰ªñ„Ç§„Éô„É≥„Éà:", parsed.type);
          }
        } catch (e) {
          console.warn("‚ö†Ô∏è ÈùûJSON„É°„ÉÉ„Çª„Éº„Ç∏:", msg);
          if (msg.toLowerCase().includes("response")) {
            appendAI(msg);
          } else {
            appendUser(msg);
          }
        }
      };
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach((track)=>pc.addTrack(track, stream));

      // ‚úÖ „É™„É¢„Éº„ÉàÈü≥Â£∞„ÇíÂÜçÁîü„Åô„Çã MediaStreamTrack „ÇíÂá¶ÁêÜ
      pc.ontrack = (event) => {
        const remoteStream = event.streams[0];
        const audioEl = document.createElement("audio");
        audioEl.srcObject = remoteStream;
        audioEl.autoplay = true;
        document.body.appendChild(audioEl);
        appendStatus("üéß „É™„É¢„Éº„ÉàÈü≥Â£∞„Çπ„Éà„É™„Éº„É†Âèó‰ø°‰∏≠...");
      };

      // ‚úÖ onconnectionstatechange „Åß„Éá„Éê„ÉÉ„Ç∞Âá∫Âäõ
      pc.onconnectionstatechange = () => {
        appendStatus("PeerConnection Áä∂ÊÖã: " + pc.connectionState);
      };

      // ‚úÖ DataChannelÂèó‰ø°„ÇÇÁ¢∫Ë™ç
      pc.ondatachannel = (event) => {
        const ch = event.channel;
        ch.onmessage = (ev) => appendStatus("üì© DataChannel message: " + ev.data);
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      return offer;
    }

    document.getElementById('start-btn').addEventListener('click', startRealtime);
  </script>
</body>
</html>
