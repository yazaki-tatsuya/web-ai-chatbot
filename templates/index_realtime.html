<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Realtime Èü≥Â£∞Âêπ„ÅçÂá∫„Åó v2 (JWT)</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f0f2f5;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
    }
    #chat {
      width: 80%;
      max-width: 800px;
      height: 400px;
      overflow-y: auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 10px;
      margin-top: 20px;
    }
    .user {
      background-color: #d1e7dd;
      padding: 8px 10px;
      border-radius: 6px;
      margin: 6px;
      text-align: right;
    }
    .ai {
      background-color: #f8d7da;
      padding: 8px 10px;
      border-radius: 6px;
      margin: 6px;
      text-align: left;
    }
    #status {
      margin-top: 10px;
      width: 80%;
      max-width: 800px;
      height: 80px;
      background: #f4f4f4;
      overflow-y: auto;
      padding: 5px;
      border-radius: 5px;
      font-size: 0.9em;
      color: gray;
    }
  </style>
</head>
<body>
  <h3>Realtime Audio Chat (JWTÁõ¥Áµê)</h3>
  <div class="mb-3">
    <!-- ‚ñº‚ñº ËøΩÂä†(1/2)Ôºö„Éó„É≠„É≥„Éó„ÉàÂÖ•ÂäõÊ¨Ñ ‚ñº‚ñº -->
    <textarea id="prompt" class="form-control mb-2" rows="3" placeholder="„Åì„Åì„Å´„Ç∑„Éä„É™„Ç™/Ë®≠ÂÆöÔºà„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„ÉàÔºâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰æãÔºö„ÅÇ„Å™„Åü„ÅØÂé≥„Åó„ÇÅ„ÅÆËã±‰ºöË©±„Ç≥„Éº„ÉÅ„Åß„Åô„ÄÇÁü≠Êñá„ÅßËøîÁ≠î„Åó„ÄÅÊØéÂõû1Êñá„Å†„ÅëÊ∑ªÂâä„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"></textarea>
    <!-- ‚ñ≤‚ñ≤ ËøΩÂä†(1/2) „Åì„Åì„Åæ„Åß ‚ñ≤‚ñ≤ -->
    <button id="start-btn" class="btn btn-primary">RealtimeÈñãÂßã</button>
  </div>
  <div id="chat"></div>
  <div id="status"></div>
  <script>
    const chat = document.getElementById('chat');
    const statusArea = document.getElementById('status');
    let pc, dataChannel;

    async function appendStatus(msg){ 
      const div = document.createElement('div');
      div.textContent = "> " + msg;
      statusArea.appendChild(div);
      statusArea.scrollTop = statusArea.scrollHeight;
    }

    // üí¨ Âêπ„ÅçÂá∫„ÅóÂΩ¢Âºè„Åß„É¶„Éº„Ç∂„ÉºÁô∫Ë©±ÔºàÁ∑ëËâ≤Ôºâ
    async function appendUser(msg) {
      const bubble = document.createElement('div');
      bubble.className = 'message user';
      bubble.textContent = msg.trim();
      chat.appendChild(bubble);
      chat.scrollTop = chat.scrollHeight;
    }

    // üí¨ Âêπ„ÅçÂá∫„ÅóÂΩ¢Âºè„ÅßAIÁô∫Ë©±ÔºàËµ§Ëâ≤Ôºâ
    async function appendAI(msg, stream = false) {
      let bubble = chat.querySelector('.message.ai.streaming');
      if (!bubble || !stream) {
        bubble = document.createElement('div');
        bubble.className = 'message ai streaming';
        // ‚ñº Â§âÊõ¥ÁÇπ(Êó¢Â≠ò„É≠„Ç∏„ÉÉ„ÇØÁ∂≠ÊåÅ)ÔºöÂèØËÉΩ„Å™„ÇâÁõ¥Ââç„ÅÆ„É¶„Éº„Ç∂„ÉºstreamingÂêπ„ÅçÂá∫„Åó„ÅÆÁõ¥Âæå„Å´ÈÖçÁΩÆ
        const u = chat.querySelector('.message.user.streaming');
        if (u && u.parentNode === chat) {
          u.insertAdjacentElement('afterend', bubble);
        } else {
          chat.appendChild(bubble);
        }
      }
      bubble.textContent = msg.trim();
      chat.scrollTop = chat.scrollHeight;
    }

    async function getJWT(){
      try {
        const res = await fetch('/jwt');
        const data = await res.json();
        return data.jwt;
      } catch(e){
        console.error("JWTÂèñÂæóÂ§±Êïó:", e);
        appendStatus("JWTÂèñÂæó„Å´Â§±Êïó");
        return null;
      }
    }

    async function startRealtime(){
      const token = await getJWT();
      if(!token){ appendStatus("„Éà„Éº„ÇØ„É≥„Å™„Åó"); return; }

      const MODEL = "gpt-realtime";
      const offer = await createLocalOffer();
      appendStatus("SDP‰ΩúÊàêÂÆå‰∫Ü");

      // ‚úÖ Flask„Çµ„Éº„Éê„Éº„ÅÆsdp-proxy„ÇíÁµåÁî±„Åó„Å¶CORS„ÇíÂõûÈÅø
      const proxyUrl = "/realtime/sdp-proxy";
      const r = await fetch(proxyUrl, {
        method: "POST",
        headers: { "Content-Type": "application/sdp" },
        body: offer.sdp
      });

      if (!r.ok) {
        appendStatus("SDP proxy fetchÂ§±Êïó: " + r.status);
        return;
      }

      const answerSDP = await r.text();
      await pc.setRemoteDescription({ type: "answer", sdp: answerSDP });
      appendStatus("RealtimeÊé•Á∂öÂÆå‰∫Ü (via Flask proxy)");
    }

    async function createLocalOffer(){
      pc = new RTCPeerConnection();
      dataChannel = pc.createDataChannel("oai-events");

      // --- DataChannel openÁõ¥Âæå„Å´ WebRTC „Çª„ÉÉ„Ç∑„Éß„É≥„Å∏ session.update „ÇíÈÄÅ„Çã --- //
      dataChannel.onopen = () => { // NEW(‚òÖ)
        // ‚ñº‚ñº ËøΩÂä†(2/2)Ôºö„ÉÜ„Ç≠„Çπ„ÉàÂÖ•ÂäõÂÄ§„Çí instructions „Å´ÈÅ©Áî® ‚ñº‚ñº
        const promptEl = document.getElementById('prompt');
        const userInstructions = (promptEl && promptEl.value.trim()) ? promptEl.value.trim()
                               : "„ÅÇ„Å™„Åü„ÅØË¶™Âàá„ÅßÊúâËÉΩ„Å™„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇÂøúÁ≠î„ÅØÁ∞°ÊΩî„Å´„ÄÇ";
        // ‚ñ≤‚ñ≤ ËøΩÂä†(2/2) „Åì„Åì„Åæ„Åß ‚ñ≤‚ñ≤

        // WebRTC„Çª„ÉÉ„Ç∑„Éß„É≥„Å´ÂØæ„Åó„Å¶‚Äú„Åì„ÅÆÊé•Á∂ö‚Äù„ÅÆË®≠ÂÆö„ÇíÈÅ©Áî®Ôºà„Çµ„Éº„ÉêÂÅ¥WS„Å´„ÅØÂΩ±Èüø„Åó„Å™„ÅÑÔºâ
        const update = {
          type: "session.update",
          session: {
            // Whisper„Åß„É¶„Éº„Ç∂„ÉºÂÖ•Âäõ„ÅÆÊñáÂ≠óËµ∑„Åì„Åó„ÇíÊúâÂäπÂåñ
            input_audio_transcription: { model: "whisper-1", language: "ja" },
            // ‰ªªÊÑèÔºö„Çµ„Éº„ÉêVADÔºàËá™ÂãïÂå∫Âàá„ÇäÔºâ„ÄÇÊó¢ÂÆö„Åß„ÇÇÂèØ
            turn_detection: { type: "server_vad" },
            // ‚ñº ËøΩÂä†Ôºö„É¶„Éº„Ç∂„ÉºÊåáÂÆö„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„ÇíÈÅ©Áî®
            instructions: userInstructions
          }
        };
        dataChannel.send(JSON.stringify(update));
        appendStatus("session.update „ÇíÈÄÅ‰ø°ÔºàWebRTC, with instructionsÔºâ");
      };
      // ----------------------------------------------------------------------- //  

      dataChannel.onmessage = (event) => {
        const msg = event.data;
        console.log("üì© DataChannelÂèó‰ø°:", msg);
        try {
          const parsed = JSON.parse(msg);
          // ‚úÖ Ê≠£Âºè‰ªïÊßò: input_audio_buffer.transcription.* „ÅÆ„Åø„Çí‰ΩøÁî®„Åó„Å¶Á∑ëÂêπ„ÅçÂá∫„Åó„ÇíÊèèÁîª
          if (!window._userBuffer) window._userBuffer = "";

          // Áô∫Ë©±ÈñãÂßã„ÅßÁ∑ë„ÅÆ streaming Âêπ„ÅçÂá∫„Åó„ÇíÂç≥Â∫ß„Å´Ë°®Á§∫
          if (parsed.type === "input_audio_buffer.speech_started") {
            let bubble = chat.querySelector('.message.user.streaming');
            if (!bubble) {
              bubble = document.createElement('div');
              bubble.className = 'message user streaming';
              bubble.textContent = '‚Ä¶';
              chat.appendChild(bubble);
            }
            chat.scrollTop = chat.scrollHeight;
          }

          if (parsed.type === "input_audio_buffer.transcription.delta" && parsed.delta) {
            // „É¶„Éº„Ç∂„ÉºÁô∫Ë©±„ÅÆÈÄî‰∏≠„Çí„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÂêπ„ÅçÂá∫„ÅóÊõ¥Êñ∞
            console.log("üü© transcription.delta:", parsed.delta);
            window._userBuffer += parsed.delta;
            let bubble = chat.querySelector('.message.user.streaming');
            if (!bubble) {
              bubble = document.createElement('div');
              bubble.className = 'message user streaming';
              chat.appendChild(bubble);
            }
            bubble.textContent = window._userBuffer.trim();
            chat.scrollTop = chat.scrollHeight;
          }
          else if (parsed.type === "input_audio_buffer.transcription.completed" && parsed.transcription) {
            // „É¶„Éº„Ç∂„ÉºÁô∫Ë©±Á¢∫ÂÆöÔºöÂêπ„ÅçÂá∫„Åó„ÇíÁ¢∫ÂÆö„Åó„Å¶Âõ∫ÂÆö
            window._userBuffer = parsed.transcription;
            let bubble = chat.querySelector('.message.user.streaming');
            if (!bubble) {
              bubble = document.createElement('div');
              bubble.className = 'message user streaming';
              chat.appendChild(bubble);
            }
            bubble.textContent = window._userBuffer.trim();
            bubble.classList.remove('streaming');
            chat.scrollTop = chat.scrollHeight;
          }
          // ‚ñº‚ñº‚ñº WebRTC‰∫íÊèõ„Ç§„Éô„É≥„Éà ‚ñº‚ñº‚ñº
          else if (parsed.type === "conversation.item.input_audio_transcription.delta" && parsed.delta) {
            window._userBuffer += parsed.delta;    
            let bubble = chat.querySelector('.message.user.streaming');
            if (!bubble) {                         
              bubble = document.createElement('div');     
              bubble.className = 'message user streaming';
              chat.appendChild(bubble);            
            }                                      
            bubble.textContent = window._userBuffer.trim();
            chat.scrollTop = chat.scrollHeight;    
          }                                        
          else if (parsed.type === "conversation.item.input_audio_transcription.completed" && parsed.transcript) {
            window._userBuffer = parsed.transcript;
            let bubble = chat.querySelector('.message.user.streaming');
            if (!bubble) {                         
              bubble = document.createElement('div');     
              bubble.className = 'message user streaming';
              chat.appendChild(bubble);            
            }                                      
            bubble.textContent = window._userBuffer.trim();
            bubble.classList.remove('streaming');  
            chat.scrollTop = chat.scrollHeight;    
          }                                        

          // ‚úÖ AIÂøúÁ≠î Âêπ„ÅçÂá∫„ÅóÁî®„Éê„ÉÉ„Éï„Ç°
          if (!window._aiBuffer) window._aiBuffer = "";

          if (parsed.type === "response.audio_transcript.delta" && parsed.delta) {
            // „Çπ„Éà„É™„Éº„Éü„É≥„Ç∞‰∏≠„ÅØÊó¢Â≠òÂêπ„ÅçÂá∫„Åó„Å´ÊñáÂ≠ó„ÇíËøΩÂä†Êõ¥Êñ∞
            window._aiBuffer += parsed.delta;
            let bubble = chat.querySelector('.message.ai.streaming');
            if (!bubble) {
              bubble = document.createElement('div');
              bubble.className = 'message ai streaming';
              const u = chat.querySelector('.message.user.streaming');
              if (u && u.parentNode === chat) {
                u.insertAdjacentElement('afterend', bubble);
              } else {
                chat.appendChild(bubble);
              }
            }
            bubble.textContent = window._aiBuffer.trim();
            chat.scrollTop = chat.scrollHeight;
          }
          else if (parsed.type === "response.audio_transcript.done" && parsed.transcript) {
            // ÊúÄÁµÇ„ÉÜ„Ç≠„Çπ„Éà„ÇíÁ¢∫ÂÆö
            window._aiBuffer = parsed.transcript;
            let bubble = chat.querySelector('.message.ai.streaming');
            if (!bubble) {
              bubble = document.createElement('div');
              bubble.className = 'message ai streaming';
              const u = chat.querySelector('.message.user.streaming');
              if (u && u.parentNode === chat) {
                u.insertAdjacentElement('afterend', bubble);
              } else {
                chat.appendChild(bubble);
              }
            }
            bubble.textContent = window._aiBuffer.trim();
            bubble.classList.remove('streaming');
            chat.scrollTop = chat.scrollHeight;
          }
          else {
            console.debug("üìò ‰ªñ„Ç§„Éô„É≥„Éà:", parsed.type);
          }
        } catch (e) {
          console.warn("‚ö†Ô∏è ÈùûJSON„É°„ÉÉ„Çª„Éº„Ç∏:", msg);
          if (msg.toLowerCase().includes("response")) {
            appendAI(msg);
          } else {
            appendUser(msg);
          }
        }
      };
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach((track)=>pc.addTrack(track, stream));

      // ‚úÖ „É™„É¢„Éº„ÉàÈü≥Â£∞„ÇíÂÜçÁîü„Åô„Çã MediaStreamTrack „ÇíÂá¶ÁêÜ
      pc.ontrack = (event) => {
        const remoteStream = event.streams[0];
        const audioEl = document.createElement("audio");
        audioEl.srcObject = remoteStream;
        audioEl.autoplay = true;
        document.body.appendChild(audioEl);
        appendStatus("üéß „É™„É¢„Éº„ÉàÈü≥Â£∞„Çπ„Éà„É™„Éº„É†Âèó‰ø°‰∏≠...");
      };

      // ‚úÖ onconnectionstatechange „Åß„Éá„Éê„ÉÉ„Ç∞Âá∫Âäõ
      pc.onconnectionstatechange = () => {
        appendStatus("PeerConnection Áä∂ÊÖã: " + pc.connectionState);
      };

      // ‚úÖ DataChannelÂèó‰ø°„ÇÇÁ¢∫Ë™ç
      pc.ondatachannel = (event) => {
        const ch = event.channel;
        ch.onmessage = (ev) => appendStatus("üì© DataChannel message: " + ev.data);
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      return offer;
    }

    document.getElementById('start-btn').addEventListener('click', startRealtime);
  </script>
</body>
</html>
